<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8" />
    <!-- [iOSå„ªåŒ–] viewport-fit=cover è®“å…§å®¹å»¶ä¼¸åˆ°ç€æµ·å€ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>IGCSEä¸€æ—¥ä¸€å­—demo</title>
    
    <!-- PWA è¨­å®š -->
    <meta name="theme-color" content="#f5f5dc" />
    <link rel="icon" type="image/png" href="./icon.png" />
    <link rel="apple-touch-icon" href="./icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <!-- [iOSå„ªåŒ–] è®“ iOS æ”¯æ´ PWA å…¨è¢å¹•æ¨¡å¼ (éš±è— Safari å·¥å…·åˆ—) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IGCSEç²µèª">

    <!-- 1. å¼•å…¥ React å’Œ Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- å¼•å…¥ Confetti (ç¦®èŠ±ç‚®) ç‰¹æ•ˆåº« -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <!-- 2. å¼•å…¥å­—åº« -->
    <script src="./words.js"></script>

    <!-- 3. CSS æ¨£å¼ï¼šå®Œç¾å¾©åˆ»ç­†è¨˜æœ¬é¢¨æ ¼ -->
    <style>
        /* [iOSå„ªåŒ–] å…¨å±€ç¦æ­¢é¸å–æ–‡å­—ï¼Œä¸¦ç§»é™¤é»æ“Šé«˜äº® */
        * {
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šæ™‚çš„è—è‰²/ç°è‰²æ¡† */
            box-sizing: border-box;
        }

        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            /* [iOSå„ªåŒ–] ç¦æ­¢é•·æŒ‰é¸å–æ–‡å­— */
            -webkit-user-select: none;
            user-select: none;
            /* [iOSå„ªåŒ–] é˜²æ­¢ iOS å›å½ˆæ•ˆæœ */
            overscroll-behavior-y: none;
        }
        
        .page-wrapper {
            min-height: 100vh;
            width: 100%;
            background-color: #f5f5dc;
            /* æ©«ç·šç´™ç´‹ç† */
            background-image: url("https://www.transparenttextures.com/patterns/lined-paper-2.png");
            color: #000;
            display: flex;
            justify-content: center;
        }

        .app-container { 
            width: 100%;
            max-width: 480px; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            position: relative;
            background: transparent;
        }
        
        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* [iOSå„ªåŒ–] å¢åŠ  padding-top ä»¥é¿é–‹ç€æµ· (Safe Area) */
            padding: max(15px, env(safe-area-inset-top)) 20px 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(245, 245, 220, 0.95);
            border-bottom: 2px solid #000;
            /* [iOSå„ªåŒ–] é«˜åº¦è‡ªå‹•é©æ‡‰ç€æµ· */
            height: auto; 
            min-height: 60px;
        }
        .header-title { 
            font-size: 1.2rem; 
            font-weight: bold; 
            transition: color 0.3s;
        }
        
        /* [å‹•ç•«] ç­”å°æ™‚çš„å½ˆè·³å‹•ç•« */
        @keyframes popSuccess {
            0% { transform: scale(1); color: #000; }
            50% { transform: scale(1.4); color: #2e7d32; } /* è®Šå¤§ä¸”è®Šç¶  */
            100% { transform: scale(1); color: #000; }
        }
        .animate-pop-success {
            animation: popSuccess 0.4s ease-out;
        }

        /* [å‹•ç•«] ç­”éŒ¯æ™‚çš„æ–æ™ƒå‹•ç•« */
        @keyframes shakeError {
            0% { transform: translateX(0); color: #000; }
            25% { transform: translateX(-5px); color: #d32f2f; } /* è®Šç´… */
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); color: #000; }
        }
        .animate-shake-error {
            animation: shakeError 0.4s ease-in-out;
        }

        .streak-badge { 
            font-size: 0.9rem; 
            font-weight: bold; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Home éµç„¡æ¡†æ¨£å¼ */
        .header-home-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .header-home-btn:active {
            transform: scale(0.9);
        }

        /* [iOSå„ªåŒ–] åº•éƒ¨å…§å®¹é¿é–‹ Home Indicator (é»‘æ¢) */
        .content-area { 
            padding: 20px; 
            flex: 1; 
            overflow-y: auto; 
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        /* UI å…ƒä»¶ï¼šæŒ‰éˆ•èˆ‡å¡ç‰‡ */
        .btn {
            display: block;
            width: 100%;
            background-color: #fff;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 15px;
            font-size: 1rem;
            margin-bottom: 12px;
            cursor: pointer;
            text-align: left;
            transition: transform 0.1s, background 0.1s;
            position: relative;
            color: #000;
        }
        .btn:active { transform: scale(0.98); background-color: #eee; }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background-color: #e0e0e0; 
            border-color: #999; 
            color: #888;
        }
        .btn-center { text-align: center; }

        .btn-primary { background-color: #000; color: #fff; text-align: center; }
        .btn-secondary { background-color: #fff; color: #000; text-align: center; }
        
        .btn-resume { 
            background-color: #ffeb3b; 
            color: #000; 
            border: 2px solid #000; 
            text-align: center; 
            font-weight: bold;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
        }
        
        .btn-audio { width: auto; display: inline-block; padding: 5px 12px; margin-top: 10px; font-size: 0.9rem; background-color: #fff; color: #000; }
        .btn-small { width: auto; padding: 8px 16px; font-size: 0.9rem; margin-bottom: 20px; display: inline-block; text-align: center; }
        .btn-next { text-align: center; font-weight: bold; margin-top: 20px; }
        
        .card {
            background-color: #fff;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
        }

        /* æ–‡å­—æ¨£å¼ - [UIä¿®æ”¹] é¡Œç›®æ”¾å¤§ */
        .chinese-text { font-size: 5rem; margin: 10px 0; font-weight: bold; }
        .jyutping-text { font-size: 1.2rem; color: #555; margin-bottom: 10px; }
        
        /* æ¸¬é©—é¸é … - [UIä¿®æ”¹] é¸é …ä½ˆå±€ */
        .options-grid { display: flex; flex-direction: column; gap: 10px; }
        
        /* æ–°çš„é¸é …å®¹å™¨æ¨£å¼ (å–ä»£åŸæœ¬å–®ç´”çš„ button) */
        .option-container {
            display: flex;
            align-items: stretch; /* è®“å·¦å³é«˜åº¦ä¸€è‡´ */
            background-color: #fff;
            border: 3px solid #000;
            border-radius: 8px;
            margin-bottom: 0; /* grid gap è™•ç†é–“è· */
            cursor: pointer;
            overflow: hidden; /* ç¢ºä¿åœ“è§’ */
            transition: transform 0.1s;
        }
        .option-container:active { transform: scale(0.98); }
        
        /* å·¦å´æ–‡å­—å€åŸŸ */
        .option-text-area {
            flex: 1; /* ä½”æ“šå¤§éƒ¨åˆ†ç©ºé–“ */
            padding: 15px;
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            border-right: 1px solid #ddd; /* åˆ†éš”ç·š */
        }
        
        /* å³å´éŸ³é »æŒ‰éˆ•å€åŸŸ */
        .option-audio-area {
            width: 50px; /* å›ºå®šå¯¬åº¦ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: #f9f9f9;
        }
        .option-audio-area:active { background: #e0e0e0; }

        /* ç‹€æ…‹æ¨£å¼ */
        .option-container.correct { background: #000; color: #fff; border-color: #000 !important; }
        .option-container.correct .option-audio-area { background: #333; color: #fff; border-left-color: #555; }
        
        /* [UIä¿®å¾©] ç§»é™¤äº† text-decoration: line-through */
        .option-container.wrong { background: #ccc; border-color: #999 !important; color: #333; }
        .option-container.disabled { pointer-events: none; opacity: 0.6; }

        /* è¨ˆæ™‚å™¨æ¢ */
        .timer-grid { display: flex; gap: 4px; margin-bottom: 20px; height: 12px; }
        .timer-block { flex: 1; background: #ddd; border: 1px solid #999; border-radius: 2px; }
        .timer-block.active { background: #000; border-color: #000; }
        .timer-block.active.danger { background: #ff4d4d; border-color: #ff4d4d; }

        /* WordBank (åŸ Pokedex) */
        .unlocked-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            text-align: left; 
            cursor: pointer; 
            padding: 15px;
        }
        .unlocked-card:active { background: #f9f9f9; }
        /* [UIä¿®æ”¹] WordBank å­—é«”æ”¾å¤§ */
        .word-chinese { font-size: 2rem; font-weight: bold; }
        .word-english { font-size: 1.2rem; color: #666; }
        .word-jyutping-small { font-size: 0.9rem; color: #888; }

        /* å€å¡Šæ¨™é¡Œ */
        .section-header {
            text-align: left;
            margin: 25px 0 15px;
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            border-bottom: 2px dashed #999;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* é–å®šç‹€æ…‹ Badge */
        .status-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            float: right;
            vertical-align: middle;
        }
        .badge-locked { background: #eee; color: #666; }
        .badge-completed { background: #000; color: #fff; }
        
        .feedback-section { animation: fadeIn 0.3s; text-align: center; margin-top: 20px; }
        .feedback-text { font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; }

        .topic-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const WORDS = window.WORDS || [];

        const APP_VERSION = '2.25'; // Update version
        const OPTION_COLORS = ['#D72600', '#ECD407', '#379711', '#0956BF'];

        const CATEGORIES = {
            HIGH_FREQ: [
                "Pronouns", "Countries/Languages", "Numbers", "Quantities", "Colours", 
                "Time", "Days", "Months", "Verbs", "Modal verbs", "Adjectives", 
                "Adverbs", "Question words", "Locations", "Connecting words", 
                "Social", "Abbreviations", "Others"
            ],
            TOPIC_RELATED: [
                "Town & Rural", "Holidays", "Services", "Customs", "Traditions", 
                "School Life", "School Rules", "School Trips", "Work", "Future Plans", 
                "Home", "Daily Routine", "Role Models", "Family", "Childhood", 
                "Environment Issues", "Weather", "Transport", "Media", "Technology", 
                "Special Occasions", "Food & Drink", "Hobbies", "Shopping", "Health"
            ]
        };

        const getTopicEmoji = (topic) => {
             const map = {
                "Pronouns": "ğŸ‘†", "Countries/Languages": "ğŸŒ", "Numbers": "1ï¸âƒ£", "Food & Drink": "ğŸ”",
                "School Life": "ğŸ’", "Animals": "ğŸ¶", "Transport": "ğŸš—", "Time": "â°",
                "Family": "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§", "Weather": "ğŸŒ¤ï¸", "Shopping": "ğŸ›ï¸", "Health": "ğŸ¥",
                "Technology": "ğŸ’»", "Holidays": "ğŸ–ï¸", "Work": "ğŸ’¼", "School Rules": "ğŸ“œ",
                "Services": "ğŸ“®", "Home": "ğŸ "
            };
            return map[topic] || "ğŸ“‚";
        };

        // Fisher-Yates æ´—ç‰Œç®—æ³•
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        const getTodayString = () => new Date().toDateString();

        // [Bug Fix 2: Helper] å°‹æ‰¾ iOS å–„æ€¡è€å¸« (Sin-ji)
        const getCantoneseVoice = () => {
            if (!('speechSynthesis' in window)) return null;
            const voices = window.speechSynthesis.getVoices();
            // å„ªå…ˆæ‰¾åå­—æœ‰ 'Sin-ji' æˆ– 'å–„æ€¡' çš„è²éŸ³
            return voices.find(v => v.name.includes('Sin-ji') || v.name.includes('å–„æ€¡')) || null;
        };

        // [æ–°å¢] å°‹æ‰¾è‹±æ–‡èªéŸ³ (Samantha / Fred ç­‰) ä»¥ä¿®å¾© iOS æ··éŸ³å•é¡Œ
        const getEnglishVoice = () => {
            if (!('speechSynthesis' in window)) return null;
            const voices = window.speechSynthesis.getVoices();
            // å„ªå…ˆç´š: 1. Samantha (iOS é è¨­å„ªè³ª) 2. Fred (iOS é è¨­) 3. Daniel (iOS è‹±å¼) 4. ä»»ä½•è‹±æ–‡
            return voices.find(v => v.name.includes('Samantha')) ||
                   voices.find(v => v.name.includes('Fred')) ||
                   voices.find(v => v.name.includes('Daniel')) ||
                   voices.find(v => v.lang.includes('en-')) || null;
        };

        // ---------------------------------------------------------
        // QuizView: æ¸¬é©—ä»‹é¢
        // ---------------------------------------------------------
        const QuizView = ({ wordsToQuiz, initialIndex, mode, onFinish, progress, setProgress, currentStreak, setCurrentStreak, onUpdateMaxStreak, handleDailyCheckIn, saveSession, clearSession, existingSession, setHeaderTitle, setHeaderClass }) => {
            const [currentIndex, setCurrentIndex] = useState(initialIndex || 0);
            const [currentOptions, setCurrentOptions] = useState([]);
            const [hasAnswered, setHasAnswered] = useState(false);
            const [timeLeft, setTimeLeft] = useState(10);
            const timerRef = useRef(null);

            const currentWord = wordsToQuiz[currentIndex];
            const isTimedMode = mode === 'SPEED_QUIZ' || mode === 'MARATHON';

            // [åˆå§‹åŒ–æ¨™é¡Œ]
            useEffect(() => {
                // é€²å…¥ Quiz Modeï¼Œæ¨™é¡Œæ”¹ç‚ºç©ºç™½
                setHeaderTitle("");
                setHeaderClass("");
            }, []);

            // [æ©Ÿåˆ¶ 3: å­˜æª” & é˜²ä½œå¼Š] æ¯æ¬¡é¡Œç›®æ”¹è®Šæ™‚å­˜æª”
            useEffect(() => {
                if (currentWord && currentOptions.length > 0) {
                    saveSession({
                        wordsToQuiz: wordsToQuiz, 
                        currentIndex: currentIndex,
                        mode: mode,
                        currentOptions: currentOptions, 
                        currentWordId: currentWord.id,
                        // [Bug Fix 3] åŠ å­˜ topic ä»¥ä¾¿ Force to Top æª¢æŸ¥
                        topic: currentWord.topic 
                    });
                }
            }, [currentIndex, currentWord, currentOptions, mode]);

            useEffect(() => {
                if (!currentWord) return;
                
                // é‡ç½®ç‹€æ…‹
                setHasAnswered(false);
                setTimeLeft(10);
                // é‡ç½®æ¨™é¡Œ (å¦‚æœæ˜¯ä¸‹ä¸€é¡Œ)
                setHeaderTitle(""); 
                setHeaderClass("");

                if (existingSession && existingSession.currentWordId === currentWord.id && existingSession.currentOptions) {
                     if (currentIndex === initialIndex && currentOptions.length === 0) {
                         setCurrentOptions(existingSession.currentOptions);
                         return; 
                     }
                }
                
                const validDistractors = WORDS.filter(candidate => {
                    if (candidate.id === currentWord.id) return false;
                    if (currentWord.group_id && candidate.group_id) {
                        if (currentWord.group_id === candidate.group_id) return false;
                    }
                    if (currentWord.synonym_group && candidate.synonym_group) {
                         if (currentWord.synonym_group === candidate.synonym_group) return false;
                    }
                    return true;
                });

                const shuffledDistractors = shuffleArray(validDistractors).slice(0, 3);
                const finalOptions = shuffleArray([currentWord, ...shuffledDistractors]);
                
                setCurrentOptions(finalOptions);
            }, [currentIndex, currentWord]); 

            // [ä¿®å¾© 1: è¨ˆæ™‚å™¨å„ªåŒ–] ç§»é™¤ä¾è³´ timeLeftï¼Œé¿å…æ¯ç§’é‡å•Ÿ
            useEffect(() => {
                if (isTimedMode && !hasAnswered) {
                    timerRef.current = setInterval(() => {
                        setTimeLeft((prevTime) => {
                            if (prevTime <= 1) {
                                clearInterval(timerRef.current);
                                return 0;
                            }
                            return prevTime - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timerRef.current);
            }, [isTimedMode, hasAnswered]);

            // æ’­æ”¾é¡Œç›®çš„å»£æ±è©± [Bug Fix 2: æ‡‰ç”¨å–„æ€¡è€å¸«]
            const playAudio = () => {
                if (!('speechSynthesis' in window)) return;
                // [ä¿®å¾© 2: èªéŸ³é˜²æ’]
                window.speechSynthesis.cancel();
                
                const u = new SpeechSynthesisUtterance(currentWord.chinese);
                u.lang = 'zh-HK';
                u.rate = 0.6;
                
                // å˜—è©¦æŒ‡å®šèªéŸ³
                const sinji = getCantoneseVoice();
                if (sinji) u.voice = sinji;

                setTimeout(() => {
                    window.speechSynthesis.speak(u);
                }, 10);
            };

            // æ’­æ”¾é¸é …çš„è‹±æ–‡ (é»æ“Šå–‡å­æ™‚)
            const playOptionAudio = (text) => {
                if (!('speechSynthesis' in window)) return;
                // [ä¿®å¾© 2: èªéŸ³é˜²æ’]
                window.speechSynthesis.cancel();
                
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; // é¸é …æ˜¯è‹±æ–‡
                u.rate = 0.8;
                
                // [æ–°å¢] å¼·åˆ¶æŒ‡å®šè‹±æ–‡èªéŸ³ (å¦‚ Samantha)ï¼Œé¿å… iOS ç”¨ Sin-ji è®€è‹±æ–‡
                const engVoice = getEnglishVoice();
                if (engVoice) u.voice = engVoice;
                
                setTimeout(() => {
                    window.speechSynthesis.speak(u);
                }, 10);
            };

            const handleOptionClick = (selected) => {
                if (hasAnswered) return;
                clearInterval(timerRef.current);
                setHasAnswered(true);
                
                const isCorrect = selected.id === currentWord.id;
                const newProgress = { ...progress };
                const wordId = currentWord.id;
                const status = newProgress[wordId] || { status: 'LOCKED', review_count: 0 };

                // [åŠ åˆ†é‚è¼¯]
                // 1. é è¨­ä¸åŠ åˆ†
                let shouldAddScore = false;

                if (isCorrect) {
                    status.status = 'UNLOCKED';
                    
                    // 2. åˆ¤æ–·æ˜¯å¦åŠ åˆ†
                    if (isTimedMode) {
                        // Quiz & Marathon: å¿…é ˆåœ¨æ™‚é–“çµæŸå‰ (timeLeft > 0) ä¹Ÿå°±æ˜¯10ç§’å…§ç­”å°æ‰åŠ åˆ†
                        // å¦‚æœæ™‚é–“è®Šæˆ 0 æ‰æŒ‰ï¼Œå°±ä¸åŠ åˆ†
                        if (timeLeft > 0) {
                            shouldAddScore = true;
                        }
                    } else {
                        // éè¨ˆæ™‚æ¨¡å¼ (Adventure, Review)ï¼šç­”å°å°±åŠ åˆ†
                        shouldAddScore = true;
                    }

                    // 3. åŸ·è¡ŒåŠ åˆ†
                    if (shouldAddScore) {
                        status.review_count = (status.review_count || 0) + 1;
                    }
                    
                    // [ä¿®æ”¹] æ›´æ–° Header é¡¯ç¤º Correct
                    setHeaderTitle("âœ… Correct!");
                    setHeaderClass("animate-pop-success");

                    // [æ–°å¢] è§¸ç™¼ç¦®èŠ±ç‚® (Confetti)
                    if (window.confetti) {
                        window.confetti({
                            particleCount: 150,
                            spread: 60,
                            origin: { y: 0.7 },
                            colors: OPTION_COLORS, // ä½¿ç”¨ App ä¸»é¡Œè‰²
                            disableForReducedMotion: true
                        });
                    }

                    // [Bug Fix 1] åªæœ‰åœ¨è¨ˆæ™‚æ¨¡å¼æ‰æ›´æ–°é€£å‹ï¼Œä¸”å†’éšª/è¤‡ç¿’æ¨¡å¼ä¸å½±éŸ¿
                    if (mode === 'SPEED_QUIZ' || mode === 'MARATHON') {
                        const newStreak = currentStreak + 1;
                        setCurrentStreak(newStreak);
                        onUpdateMaxStreak(newStreak);
                    }
                } else {
                    if (status.status === 'LOCKED') status.status = 'SEEN';
                    
                    // [ä¿®æ”¹] æ›´æ–° Header é¡¯ç¤º Incorrect
                    setHeaderTitle("âŒ Incorrect!");
                    setHeaderClass("animate-shake-error");

                    // [Bug Fix 1] åªæœ‰åœ¨è¨ˆæ™‚æ¨¡å¼æ‰æ­¸é›¶é€£å‹
                    if (mode === 'SPEED_QUIZ' || mode === 'MARATHON') {
                        setCurrentStreak(0);
                    }
                }

                newProgress[wordId] = status;
                setProgress(newProgress);
                localStorage.setItem('igcse_progress_v2', JSON.stringify(newProgress));
            };

            const handleNext = () => {
                if (currentIndex < wordsToQuiz.length - 1) {
                    setCurrentIndex(prev => prev + 1);
                } else {
                    if (mode === 'REVIEW') {
                        handleDailyCheckIn();
                    }
                    clearSession();
                    onFinish();
                }
            };

            if (!currentWord) return <div>Loading...</div>;

            const remaining = wordsToQuiz.length - currentIndex;

            return (
                <div className="quiz-container">
                    <div className="quiz-header-info">
                        <span style={{fontWeight:'bold'}}>Target: {remaining} words</span>
                    </div>

                    {isTimedMode && !hasAnswered && (
                        <div className="timer-grid">
                            {Array.from({ length: 10 }).map((_, i) => (
                                <div key={i} className={`timer-block ${i + 1 <= timeLeft ? 'active' : ''} ${timeLeft <= 3 ? 'danger' : ''}`}></div>
                            ))}
                        </div>
                    )}

                    <div className="card">
                        <h1 className="chinese-text">{currentWord.chinese}</h1>
                        <p className="jyutping-text">{currentWord.jyutping}</p>
                        <button className="btn btn-audio btn-primary" onClick={playAudio}>ğŸ”Š Play Audio</button>
                    </div>

                    <div className="options-grid">
                        {currentOptions.map((opt, i) => {
                            let containerClass = "option-container";
                            if (hasAnswered) {
                                if (opt.id === currentWord.id) containerClass += " correct";
                                else if (opt.id !== currentWord.id && currentOptions.indexOf(opt) === i) containerClass += " wrong";
                                else containerClass += " disabled";
                            }
                            const borderColor = OPTION_COLORS[i % 4];

                            return (
                                <div 
                                    key={opt.id} 
                                    className={containerClass} 
                                    style={{
                                        borderColor: borderColor,
                                    }}
                                    onClick={() => handleOptionClick(opt)}
                                >
                                    {/* å·¦å´æ–‡å­—å€åŸŸ */}
                                    <div className="option-text-area">
                                        {opt.english}
                                    </div>
                                    
                                    {/* å³å´éŸ³é »æŒ‰éˆ•å€åŸŸ */}
                                    <div 
                                        className="option-audio-area"
                                        onClick={(e) => {
                                            e.stopPropagation(); // é˜²æ­¢è§¸ç™¼ç­”é¡Œ
                                            playOptionAudio(opt.english);
                                        }}
                                    >
                                        ğŸ”Š
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {hasAnswered && (
                        <div className="feedback-section">
                            {/* [ä¿®æ”¹] ç§»é™¤äº†é€™è£¡çš„æ–‡å­—å›é¥‹ï¼Œå› ç‚ºå·²ç¶“æ¬åˆ°æ¨™é¡Œäº† */}
                            <button className="btn btn-primary btn-next" onClick={handleNext}>
                                {currentIndex < wordsToQuiz.length - 1 ? 'Next â¡' : 'Finish'}
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // ---------------------------------------------------------
        // WordBankView (åŸ Pokedex)
        // ---------------------------------------------------------
        const WordBankView = ({ progress, setView }) => {
            const [cat, setCat] = useState(null);
            const [topic, setTopic] = useState(null);

            const playDual = (w) => {
                // [ä¿®å¾© 2: èªéŸ³é˜²æ’ + å–„æ€¡è€å¸«]
                window.speechSynthesis.cancel();
                
                const u1 = new SpeechSynthesisUtterance(w.chinese);
                u1.lang = 'zh-HK';
                u1.rate = 0.6;
                const sinji = getCantoneseVoice();
                if (sinji) u1.voice = sinji;
                
                const u2 = new SpeechSynthesisUtterance(w.english);
                u2.lang = 'en-US';
                // [æ–°å¢] å¼·åˆ¶æŒ‡å®šè‹±æ–‡èªéŸ³
                const engVoice = getEnglishVoice();
                if (engVoice) u2.voice = engVoice;
                
                setTimeout(() => {
                    window.speechSynthesis.speak(u1);
                    window.speechSynthesis.speak(u2);
                }, 10);
            };

            if (topic) {
                const list = WORDS.filter(w => w.topic === topic);
                const unlocked = list.filter(w => progress[w.id]?.status === 'UNLOCKED');
                
                return (
                    <div className="pokedex-container">
                        <h2 style={{textAlign:'center'}}>{getTopicEmoji(topic)} {topic}</h2>
                        <div className="word-list">
                            {unlocked.length === 0 ? <p style={{textAlign:'center'}}>No words unlocked yet.</p> : 
                                unlocked.map(w => (
                                    <div key={w.id} className="card unlocked-card" onClick={() => playDual(w)}>
                                        <div className="word-main">
                                            <span className="word-chinese">{w.chinese}</span>
                                            <span className="word-jyutping-small">({w.jyutping})</span>
                                        </div>
                                        {/* [ä¿®æ”¹] ç§»é™¤æŒ‰éˆ• class å’Œ é‚Šæ¡† */}
                                        <div style={{display:'flex', flexDirection:'column', alignItems:'flex-end', gap:'5px'}}>
                                            <span className="word-english">{w.english}</span>
                                            <button 
                                                style={{background:'none', border:'none', fontSize:'1.2rem', cursor:'pointer', padding:'0 5px'}} 
                                                onClick={(e) => { e.stopPropagation(); playDual(w); }}
                                            >
                                                ğŸ”Š
                                            </button>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                );
            }

            if (cat) {
                return (
                    <div className="pokedex-container">
                        <h2 style={{textAlign:'center'}}>Select a Topic</h2>
                        <div className="topic-grid">
                            {CATEGORIES[cat].map(t => {
                                const total = WORDS.filter(w => w.topic === t).length;
                                const got = WORDS.filter(w => w.topic === t && progress[w.id]?.status === 'UNLOCKED').length;
                                return (
                                    <button key={t} className="btn" onClick={() => setTopic(t)}>
                                        {t} 
                                        <span className="status-badge badge-locked">
                                            {got}/{total}
                                        </span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            const totalGot = Object.values(progress).filter(p => p.status === 'UNLOCKED').length;
            return (
                <div className="pokedex-container">
                    <h2 style={{textAlign:'center'}}>ğŸ† Word Bank</h2>
                    <p style={{textAlign:'center', marginBottom:'20px'}}>Collected: {totalGot} / {WORDS.length}</p>
                    <div className="menu-section">
                        <button className="btn btn-center" onClick={() => setCat('HIGH_FREQ')}>ğŸ“• High Frequency Language</button>
                        <button className="btn btn-center" onClick={() => setCat('TOPIC_RELATED')}>ğŸ™ï¸ Topic-related Vocabulary</button>
                    </div>
                </div>
            );
        };

        // ---------------------------------------------------------
        // App
        // ---------------------------------------------------------
        function App() {
            const [view, setView] = useState('HOME');
            const [catView, setCatView] = useState('MAIN');
            const [quizData, setQuizData] = useState([]);
            const [quizMode, setQuizMode] = useState('MAINLINE');
            const [initialQuizIndex, setInitialQuizIndex] = useState(0);
            
            // [æ–°å¢] æ¨™é¡Œæ–‡å­—èˆ‡å‹•ç•« Class ç‹€æ…‹
            const [headerTitle, setHeaderTitle] = useState('IGCSEä¸€æ—¥ä¸€å­—demo');
            const [headerClass, setHeaderClass] = useState('');

            const [progress, setProgress] = useState(() => {
                try { return JSON.parse(localStorage.getItem('igcse_progress_v2')) || {}; } 
                catch { return {}; }
            });
            const [maxStreak, setMaxStreak] = useState(() => parseInt(localStorage.getItem('igcse_max_streak_speed_marathon') || '0'));
            const [dailyStreak, setDailyStreak] = useState(() => parseInt(localStorage.getItem('igcse_daily_streak_v2') || '0'));
            const [lastCheckIn, setLastCheckIn] = useState(() => localStorage.getItem('igcse_last_checkin_v2'));
            const [currentStreak, setCurrentStreak] = useState(0); 
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            
            const [existingSession, setExistingSession] = useState(null);

            useEffect(() => {
                window.history.replaceState({ view: 'HOME', catView: 'MAIN' }, '', '#home');
                const handlePopState = (event) => {
                    if (event.state) {
                        setView(event.state.view || 'HOME');
                        setCatView(event.state.catView || 'MAIN');
                        // [ä¿®æ”¹] æ­·å²å°èˆªæ™‚é‡ç½®æ¨™é¡Œ
                        setHeaderTitle('IGCSEä¸€æ—¥ä¸€å­—demo');
                        setHeaderClass('');
                    } else {
                        setView('HOME');
                        setCatView('MAIN');
                        setHeaderTitle('IGCSEä¸€æ—¥ä¸€å­—demo');
                    }
                };
                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, []);

            const navigate = (newView, newCatView = 'MAIN') => {
                setView(newView);
                setCatView(newCatView);
                // [ä¿®æ”¹] åˆ‡æ›ç•«é¢æ™‚é‡ç½®æ¨™é¡Œ
                if (newView === 'HOME') {
                    setHeaderTitle('IGCSEä¸€æ—¥ä¸€å­—demo');
                    setHeaderClass('');
                }
                const hash = newView === 'HOME' && newCatView === 'MAIN' ? '#home' 
                           : `#${newView.toLowerCase()}${newCatView !== 'MAIN' ? '-' + newCatView.toLowerCase() : ''}`;
                window.history.pushState({ view: newView, catView: newCatView }, '', hash);
            };

            useEffect(() => {
                if (localStorage.getItem('app_version') !== APP_VERSION) {
                    console.log("System update: Resetting data.");
                    localStorage.removeItem('igcse_user_progress'); 
                    localStorage.setItem('app_version', APP_VERSION);
                }
            }, []);

            const saveSession = (data) => {
                localStorage.setItem('igcse_quiz_session', JSON.stringify(data));
            };
            const clearSession = () => {
                localStorage.removeItem('igcse_quiz_session');
                setExistingSession(null);
            };

            // [æ©Ÿåˆ¶ 1: å¼·åˆ¶ç½®é ‚ Helper] - å·²ä¿®å¾©è·¨ Topic è¡çª Bug
            const applyForceToTopLogic = (generatedList, mode, currentTopic = null) => {
                try {
                    const sessionStr = localStorage.getItem('igcse_quiz_session');
                    if (!sessionStr) return { list: generatedList, session: null };
                    
                    const session = JSON.parse(sessionStr);
                    
                    // 1. æª¢æŸ¥æ¨¡å¼æ˜¯å¦ç›¸åŒ (Adventure vs Review vs Quiz)
                    if (session.mode !== mode) return { list: generatedList, session: null };

                    // 2. [é—œéµä¿®å¾©] å¦‚æœæ˜¯ Adventure Mode (MAINLINE)ï¼Œæª¢æŸ¥ Topic æ˜¯å¦ä¸€è‡´
                    // é˜²æ­¢åœ¨ Topic A çš„é€²åº¦å‡ºç¾åœ¨ Topic B ä¸­
                    if (mode === 'MAINLINE' && session.topic !== currentTopic) {
                        console.log("Topic mismatch, ignoring session.");
                        return { list: generatedList, session: null };
                    }

                    const savedWordId = session.currentWordId;
                    if (!savedWordId) return { list: generatedList, session: null };
                    
                    // [Bug Fix 3] åªæœ‰åœ¨ Adventure Mode æ‰éœ€è¦æª¢æŸ¥æ˜¯å¦å·²è§£é–
                    // å¦‚æœæ˜¯ Review/Quiz/Marathonï¼Œå³ä½¿å­—è§£é–äº†ä¹Ÿè¦æ¢å¾© (å› ç‚ºæœ¬ä¾†å°±æ˜¯è€ƒè§£é–çš„å­—)
                    if (mode === 'MAINLINE' && progress[savedWordId]?.status === 'UNLOCKED') {
                        console.log("Session word already unlocked, clearing session.");
                        clearSession();
                        return { list: generatedList, session: null };
                    }

                    let targetIndex = generatedList.findIndex(w => w.id === savedWordId);
                    let targetWord;

                    if (targetIndex !== -1) {
                        targetWord = generatedList[targetIndex];
                        generatedList.splice(targetIndex, 1);
                    } else {
                        targetWord = WORDS.find(w => w.id === savedWordId);
                    }

                    if (targetWord) {
                        generatedList.unshift(targetWord);
                        console.log("Force to top applied for word:", targetWord.chinese);
                        return { list: generatedList, session: session }; 
                    }
                } catch (e) { console.error("Force to top error", e); }
                
                return { list: generatedList, session: null };
            };

            const handleDailyCheckIn = () => {
                const today = getTodayString();
                if (lastCheckIn === today) return; 
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                
                let newStreak = 1;
                if (lastCheckIn === yesterday.toDateString()) newStreak = dailyStreak + 1;
                
                setDailyStreak(newStreak);
                setLastCheckIn(today);
                localStorage.setItem('igcse_daily_streak_v2', newStreak.toString());
                localStorage.setItem('igcse_last_checkin_v2', today);
            };

            const handleUpdateMaxStreak = (val) => {
                if (val > maxStreak) {
                    setMaxStreak(val);
                    localStorage.setItem('igcse_max_streak_speed_marathon', val.toString());
                }
            };

            const isTopicUnlocked = (topic, category) => {
                const list = CATEGORIES[category];
                const idx = list.indexOf(topic);
                if (idx <= 0) return true; 

                const prevTopic = list[idx - 1];
                const prevWords = WORDS.filter(w => w.topic === prevTopic);
                return prevWords.every(w => progress[w.id]?.status === 'UNLOCKED');
            };

            const startTopic = (topic) => {
                const allWords = WORDS.filter(w => w.topic === topic);
                const lockedWords = allWords.filter(w => !progress[w.id] || progress[w.id].status !== 'UNLOCKED');
                
                let rawList = lockedWords.length > 0 ? lockedWords : allWords;
                rawList = shuffleArray(rawList);

                // æ›´æ–°æ­¤è™•ï¼šå‚³å…¥ç¬¬ä¸‰å€‹åƒæ•¸ topic
                const { list, session } = applyForceToTopLogic(rawList, 'MAINLINE', topic);

                setQuizData(list);
                setExistingSession(session); 
                setInitialQuizIndex(0);      
                setQuizMode('MAINLINE');
                navigate('QUIZ');
            };

            const startReview = () => {
                const unlocked = WORDS.filter(w => progress[w.id]?.status === 'UNLOCKED');
                
                const shuffledUnlocked = shuffleArray(unlocked);
                
                const sorted = shuffledUnlocked.sort((a, b) => (progress[a.id].review_count || 0) - (progress[b.id].review_count || 0));
                
                let rawList = sorted.slice(0, 10);
                
                rawList = shuffleArray(rawList);

                const { list, session } = applyForceToTopLogic(rawList, 'REVIEW');

                setQuizData(list);
                setExistingSession(session);
                setInitialQuizIndex(0);
                setQuizMode('REVIEW');
                navigate('QUIZ');
            };

            const startSpeed = () => {
                // [Bug Fix 1] é–‹å§‹æ–°å±€ï¼Œå¼·åˆ¶é€£å‹æ­¸é›¶
                setCurrentStreak(0);

                const unlocked = WORDS.filter(w => progress[w.id]?.status === 'UNLOCKED');
                
                const shuffledUnlocked = shuffleArray(unlocked);
                
                const sorted = shuffledUnlocked.sort((a, b) => (progress[a.id].review_count || 0) - (progress[b.id].review_count || 0));
                let rawList = sorted.slice(0, 10);
                rawList = shuffleArray(rawList);

                const { list, session } = applyForceToTopLogic(rawList, 'SPEED_QUIZ');

                setQuizData(list);
                setExistingSession(session);
                setInitialQuizIndex(0);
                setQuizMode('SPEED_QUIZ');
                navigate('QUIZ');
            };

            const startMarathon = () => {
                // [Bug Fix 1] é–‹å§‹æ–°å±€ï¼Œå¼·åˆ¶é€£å‹æ­¸é›¶
                setCurrentStreak(0);

                const unlocked = WORDS.filter(w => progress[w.id]?.status === 'UNLOCKED');
                let rawList = shuffleArray(unlocked);

                const { list, session } = applyForceToTopLogic(rawList, 'MARATHON');

                setQuizData(list);
                setExistingSession(session);
                setInitialQuizIndex(0);
                setQuizMode('MARATHON');
                navigate('QUIZ');
            };

            const unlockedCount = Object.values(progress).filter(p => p.status === 'UNLOCKED').length;
            const trainingOpen = unlockedCount >= 10;

            const today = getTodayString();
            const isCheckedInToday = lastCheckIn === today;
            let displayDay = dailyStreak;
            if (!isCheckedInToday) {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                if (lastCheckIn === yesterday.toDateString()) {
                     displayDay = dailyStreak + 1; 
                } else {
                     displayDay = 0; 
                }
            }

            return (
                <div className="page-wrapper">
                    {showResetConfirm && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                            background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000
                        }}>
                            <div style={{
                                background: '#fff', padding: '20px', borderRadius: '8px', border: '2px solid #000', width: '80%', maxWidth: '300px', textAlign: 'center'
                            }}>
                                <h3>Reset Progress?</h3>
                                <p>Are you sure?</p>
                                <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                    <button className="btn" onClick={() => setShowResetConfirm(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={() => {
                                        localStorage.clear();
                                        window.location.reload();
                                    }}>Yes, Reset</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="app-container">
                        <header className="app-header">
                            <div className="header-left">
                                <span className="streak-badge">ğŸ”¥ Max: {maxStreak}</span>
                            </div>
                            {/* [ä¿®æ”¹] æ¨™é¡Œä½¿ç”¨ state æ§åˆ¶ï¼Œä¸¦åŠ å…¥å‹•ç•« class */}
                            <div className={`header-title ${headerClass}`}>
                                {headerTitle}
                            </div>
                            <button className="header-home-btn" onClick={() => navigate('HOME', 'MAIN')}>ğŸ </button>
                        </header>

                        <div className="content-area">
                            {view === 'HOME' && catView === 'MAIN' && (
                                <div className="menu-section">
                                    <div className="section-header">ğŸ—ºï¸ Adventure Mode</div>
                                    
                                    <button className="btn btn-center" onClick={() => navigate('HOME', 'HIGH_FREQ')}>
                                        ğŸ“• High Frequency Language
                                    </button>
                                    <button className="btn btn-center" onClick={() => navigate('HOME', 'TOPIC_RELATED')}>
                                        ğŸ™ï¸ Topic-related Vocabulary
                                    </button>

                                    <div className="section-header">
                                        <span>ğŸ‹ï¸ Training Center</span>
                                        <span style={{fontSize:'0.8rem', fontWeight:'normal'}}>
                                            {isCheckedInToday ? 'âœ…' : 'ğŸ“…'} Day {displayDay}
                                        </span>
                                    </div>
                                    
                                    <button className="btn btn-center" disabled={!trainingOpen} onClick={startReview}>
                                        ğŸ“ Review
                                    </button>
                                    <button className="btn btn-center" disabled={!trainingOpen} onClick={startSpeed} style={{marginTop:'10px'}}>
                                        â±ï¸ Quiz
                                    </button>
                                    <button className="btn btn-center" disabled={!trainingOpen} onClick={startMarathon} style={{marginTop:'10px'}}>
                                        ğŸƒ Marathon
                                    </button>
                                    {!trainingOpen && <p style={{textAlign:'center', fontSize:'0.8rem', color:'#666'}}>Unlock 10 words to open training</p>}

                                    <div className="section-header">ğŸ“š Collection</div>
                                    <button className="btn btn-center" onClick={() => navigate('WORDBANK')}>
                                        ğŸ’¯ Word Bank ({unlockedCount}/{WORDS.length})
                                    </button>

                                    <div style={{marginTop:'30px', textAlign:'center'}}>
                                        <button className="btn btn-small" style={{fontSize:'10px', width:'auto'}} onClick={() => setShowResetConfirm(true)}>
                                            âš ï¸ Reset All
                                        </button>
                                    </div>
                                </div>
                            )}

                            {view === 'HOME' && catView !== 'MAIN' && (
                                <div>
                                    <h2 style={{textAlign:'center', marginTop:0}}>
                                        {catView === 'HIGH_FREQ' ? 'ğŸ“• High Frequency Language' : 'ğŸ™ï¸ Topic-related Vocabulary'}
                                    </h2>
                                    <div className="topic-grid">
                                        {CATEGORIES[catView].map((t, index) => {
                                            const total = WORDS.filter(w => w.topic === t).length;
                                            const got = WORDS.filter(w => w.topic === t && progress[w.id]?.status === 'UNLOCKED').length;
                                            const isDone = total > 0 && got === total;
                                            const isOpen = isTopicUnlocked(t, catView);
                                            
                                            return (
                                                <button 
                                                    key={t} 
                                                    className="btn" 
                                                    disabled={!isOpen}
                                                    onClick={() => isOpen && startTopic(t)}
                                                    style={{opacity: isOpen ? 1 : 0.5}}
                                                >
                                                    {t}
                                                    <span className={`status-badge ${isDone ? 'badge-completed' : 'badge-locked'}`}>
                                                        {isOpen ? `${got}/${total}` : 'ğŸ”’'}
                                                    </span>
                                                </button>
                                            )
                                        })}
                                    </div>
                                </div>
                            )}

                            {view === 'QUIZ' && (
                                <QuizView 
                                    wordsToQuiz={quizData} 
                                    initialIndex={initialQuizIndex}
                                    mode={quizMode}
                                    onFinish={() => navigate('HOME', 'MAIN')}
                                    progress={progress}
                                    setProgress={setProgress}
                                    currentStreak={currentStreak}
                                    setCurrentStreak={setCurrentStreak}
                                    onUpdateMaxStreak={handleUpdateMaxStreak}
                                    handleDailyCheckIn={handleDailyCheckIn}
                                    saveSession={saveSession}
                                    clearSession={clearSession}
                                    existingSession={existingSession}
                                    // [ä¿®æ”¹] å‚³å…¥ä¿®æ”¹æ¨™é¡Œçš„æ–¹æ³•
                                    setHeaderTitle={setHeaderTitle}
                                    setHeaderClass={setHeaderClass}
                                />
                            )}

                            {view === 'WORDBANK' && (
                                <WordBankView progress={progress} setView={setView} />
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js', { scope: './' })
            .then(reg => console.log('SW registered!', reg))
            .catch(err => console.log('SW failed', err));
        });
      }
    </script>
</body>
</html>
